BUILD_MAJOR ?= 0
BUILD_MINOR ?= 0
BUILD_PATCH ?= 0
BUILD_NUMBER ?= 1
JFROG_USER_EMAIL ?=
JFROG_API_KEY ?=
TM_AM_LOG_LEVEL ?= debug

JFROG_MAVEN_REGISTRY_PREFIX ?= https://jfrog.trendmicro.com/artifactory
REGISTRY_LOCAL_AMAAS ?= amaas-maven-local

IMAGE_NAME := amaas/amaas-grpc-java-client:latest
AMAAS_SDK_NAME := cloudone-vsapi-sdk

# BSD sed does not support --version argument, use this to check if the sed is GNU or BSD one
ifeq ($(shell sed --version >/dev/null 2>&1; echo $$?),0)
SED := sed -i
else
SED := sed -i ''
endif

all: build

build:
	cp ../../protos/scan.proto scan.proto
	$(SED) 's/__PACKAGE_VERSION__/$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER)/' pom.xml
	docker build \
		-t $(IMAGE_NAME) \
		--build-arg JFROG_USER_EMAIL=$(JFROG_USER_EMAIL) \
		--build-arg JFROG_API_KEY=$(JFROG_API_KEY) \
		--build-arg JFROG_MAVEN_REGISTRY_PREFIX=$(JFROG_MAVEN_REGISTRY_PREFIX) \
		--build-arg REGISTRY_LOCAL_AMAAS=$(MAVEN_REGISTRY_LOCAL_AMAAS) \
		--build-arg PACK_CMD=deploy \
		--build-arg BUILD_VERSION=$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER) \
		.
	$(SED) 's/$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER)/__PACKAGE_VERSION__/' pom.xml

test:
	@echo "Not implemented"

clean:
	rm -f scan.proto
	rm -rf output

.PHONY: all build test clean
